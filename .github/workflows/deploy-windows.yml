name: Deploy to Windows Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for deployment'
        required: false
        default: 'Manual deployment'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to Windows Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: 22
        script: |
          echo Starting Windows deployment...
          
          where node >nul 2>nul
          if %errorlevel% neq 0 (
            echo Installing Node.js...
            powershell -Command "$url = 'https://nodejs.org/dist/v20.12.2/node-v20.12.2-x64.msi'; $output = 'C:\node-installer.msi'; Invoke-WebRequest -Uri $url -OutFile $output; Start-Process msiexec.exe -ArgumentList '/i $output /quiet' -Wait; Remove-Item $output"
            echo Node.js installed
          )
          
          where pm2 >nul 2>nul
          if %errorlevel% neq 0 (
            echo Installing PM2...
            npm install -g pm2
            echo PM2 installed
          )
          
          if not exist "C:\shortlink-builder" (
            mkdir C:\shortlink-builder
            mkdir C:\shortlink-builder\public
            echo App directory created
          )
          
          cd C:\shortlink-builder
          
          echo Downloading code...
          powershell -Command "$repoUrl = 'https://github.com/${{ github.repository }}/archive/main.zip'; Invoke-WebRequest -Uri $repoUrl -OutFile 'main.zip'; Expand-Archive -Path 'main.zip' -DestinationPath '.' -Force; Move-Item -Path 'shortlink-builder-main\*' -Destination '.' -Force; Remove-Item 'main.zip'; Remove-Item 'shortlink-builder-main' -Recurse -Force"
          echo Code extracted
          
          echo Installing dependencies...
          npm install
          
          echo Starting app...
          pm2 delete shortlink
          pm2 start server.js --name shortlink
          pm2 save
          pm2 startup
          
          echo Configuring firewall...
          powershell -Command "New-NetFirewallRule -DisplayName 'Allow Node.js' -Direction Inbound -LocalPort 3000 -Protocol TCP -Action Allow"
          powershell -Command "New-NetFirewallRule -DisplayName 'Allow HTTP' -Direction Inbound -LocalPort 80 -Protocol TCP -Action Allow"
          powershell -Command "New-NetFirewallRule -DisplayName 'Allow HTTPS' -Direction Inbound -LocalPort 443 -Protocol TCP -Action Allow"
          
          echo Deployment completed successfully!
          echo App running at: http://160.187.210.155:3000
