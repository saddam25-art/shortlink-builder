name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          # Update system
          apt update && apt upgrade -y
          
          # Install Node.js if not exists
          if ! command -v node &> /dev/null; then
            curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
            apt install -y nodejs
          fi
          
          # Install PM2 if not exists
          if ! command -v pm2 &> /dev/null; then
            npm install -g pm2
          fi
          
          # Install Nginx if not exists
          if ! command -v nginx &> /dev/null; then
            apt install -y nginx
          fi
          
          # Create app directory
          mkdir -p /var/www/shortlink-builder/public
          cd /var/www/shortlink-builder
          
          # Download latest code
          curl -sL https://github.com/${{ github.repository }}/archive/main.tar.gz | tar xz --strip-components=1
          
          # Install dependencies
          npm install
          
          # Setup Nginx
          cat > /etc/nginx/sites-available/shortlink << 'EOF'
          server {
              listen 80;
              server_name _;
              location / {
                  proxy_pass http://127.0.0.1:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
          }
          EOF
          
          ln -sf /etc/nginx/sites-available/shortlink /etc/nginx/sites-enabled/
          rm -f /etc/nginx/sites-enabled/default
          nginx -t && systemctl restart nginx
          
          # Start app with PM2
          pm2 delete shortlink 2>/dev/null || true
          pm2 start server.js --name shortlink
          pm2 save
          pm2 startup
          
          # Open firewall
          ufw allow 80
          ufw allow 443
          ufw --force enable
          
          echo "Deployment completed!"
